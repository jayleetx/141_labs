---
title: "Data Wrangling"
output:
  html_document:
    highlight: pygments
    theme: cerulean
    css: ../lab.css
---

```{r global_options, include=FALSE}
knitr::opts_chunk$set(eval = FALSE)
library(dplyr)
library(ggplot2)
library(oilabs)
library(pnwflights14)
data(flights)
```

The `pnwflights16-17` package has a data set called `flights` which contains *all* of the flights that 
left from Seattle-Tacoma International Airport and Portland International Airport from June 2016 to May 2017.
We will generate simple graphical and numerical summaries of data on these flights and explore delay times.
As this is a large data set, you'll also get to practice the indispensable skills of data processing 
and subsetting.

```{r load-packages, message=FALSE}
# library(devtools)
# install_github(c("MYancheff/oilabs", "MYancheff/pnwflights16-17"))
library(dplyr)
library(ggplot2)
library(oilabs)
library(pnwflights14) # still saved locally as pnwflights14
data(flights)
```

To get a sense of what this data frame contains the codebook
can be accessed by pulling up the help file:

```{r}
?flights
```

One of the variables refers to the carrier (i.e. airline) of the flight, which 
is coded according to the following system.

- `carrier`: Two letter carrier abbreviation.
    + `9E`:           Endeavor Air Inc.
    + `AA`:      American Airlines Inc.
    + `AS`:        Alaska Airlines Inc.
    + `B6`:             JetBlue Airways
    + `DL`:        Delta Air Lines Inc.
    + `EV`:    ExpressJet Airlines Inc.
    + `F9`:      Frontier Airlines Inc.
    + `FL`: AirTran Airways Corporation
    + `HA`:      Hawaiian Airlines Inc.
    + `MQ`:                   Envoy Air
    + `OO`:       SkyWest Airlines Inc.
    + `UA`:       United Air Lines Inc.
    + `US`:             US Airways Inc.
    + `VX`:              Virgin America
    + `WN`:      Southwest Airlines Co.
    + `YV`:          Mesa Airlines Inc.

All of the following exercises require at least a bit of code for their answers.

1.  What proportion of the these flights left from Portland? What is their most common destination? 
Most distant destination? 

1.  Describe the distribution of departure delays for all flights using a histogram and appropriate summary statistics. 

1.  Create a dataframe that contains the median and interquartile range for departure delays, grouped by carrier.
Which carrier has the least variable departure delays?

1.  Create a dataframe that contains the average departure delay grouped by month. Which month seems to be the best for avoiding delays?

1.  Using the airport nearest one of your hometowns, which day of the week and which airline seems best for 
flying there from Portland? Be clear on how you're defining *best*. (note that there is no explicit weekday 
column in this data set, but there is sufficient information to piece it together. The following line of code 
can be added to your pipeline to create that new column. It uses functions in the `lubridate` package, so be 
sure to load it in at the start of this exercise).

```{r eval = FALSE}
mutate(day_of_week = wday(ymd(paste(year, month, day, set = "-")), label = T))
```


1.  Mutate the data frame so that it includes a new variable that contains the 
average speed, `avg_speed` traveled by the plane for each flight (in mph).
**Hint:** Average speed can be calculated as distance divided by
number of hours of travel, and note that `air_time` is given in minutes.
Create a scatterplot of average speed vs. distance and describe the relationship.

1.  The plot below displays the relationship between the mean arrival 
delay and the mean distance traveled by every plane in the data set. 
It also shows the total number of flights made by each plane by the 
size of the plotted circle. Please form a single chain that will 
create this plot, starting with the raw data set. You will also want 
to exclude the edge cases from your analysis, so focus on the
planes that have logged more than 20 flights and flown an average
distance of less than 2000 miles. The points can be made transparent 
by adding an argument to `geom_point()`: `alpha = .1`.

```{r echo = FALSE, eval = TRUE, message = FALSE, warning = FALSE}
flights %>%
  group_by(tailnum) %>%
  summarize(avg_delay = mean(arr_delay, na.rm = TRUE),
            avg_dist = mean(distance, na.rm = TRUE),
            n = n()) %>%
  filter(n > 20,
         avg_dist < 2000) %>%
  ggplot(aes(x = avg_dist, y = avg_delay)) + 
  geom_point(alpha = .1, aes(size = n))
```





